"""new table: docker_image_config

Revision ID: 7ae563c37539
Revises: 8a0ec02bf344
Create Date: 2022-01-14 15:07:00.553848

"""
import sqlalchemy as sa

from alembic import context, op

# revision identifiers, used by Alembic.
revision = "7ae563c37539"
down_revision = "8a0ec02bf344"
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    # Create New Table `docker_image_config`
    op.create_table(
        "docker_image_config",
        sa.Column("image_id", sa.Integer(), nullable=False),
        sa.Column("config", sa.Text(length=2000), nullable=False),
        sa.Column("type", sa.Integer(), nullable=False),
        sa.PrimaryKeyConstraint("image_id", "type"),
        sa.UniqueConstraint("image_id", "type", name="unique_image_type"),
    )
    op.create_index(
        op.f("ix_docker_image_config_image_id"),
        "docker_image_config",
        ["image_id"],
        unique=False,
    )
    op.create_index(
        op.f("ix_docker_image_config_type"),
        "docker_image_config",
        ["type"],
        unique=False,
    )

    # Remove obsolete columns from `docker_image`
    if context.get_x_argument(as_dictionary=True).get("sqlite", None):
        with op.batch_alter_table("docker_image") as batch_op:
            batch_op.drop_index("ix_docker_image_type")
            batch_op.drop_column("type")
            batch_op.drop_column("config")
    else:
        op.drop_index("ix_docker_image_type", table_name="docker_image")
        op.drop_column("docker_image", "type")
        op.drop_column("docker_image", "config")
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    if context.get_x_argument(as_dictionary=True).get("sqlite", None):
        with op.batch_alter_table("docker_image") as batch_op:
            batch_op.add_column(
                sa.Column("config", sa.TEXT(length=2000), nullable=True)
            )
            batch_op.add_column(sa.Column("type", sa.INTEGER(), nullable=True))
            batch_op.create_index("ix_docker_image_type", ["type"], unique=False)
    else:
        op.drop_index(
            op.f("ix_docker_image_config_type"), table_name="docker_image_config"
        )
        op.drop_index(
            op.f("ix_docker_image_config_image_id"), table_name="docker_image_config"
        )
        op.drop_table("docker_image_config")
    # ### end Alembic commands ###
